# Qwen-7B

This document shows how to build and run a Qwen-7B model in TensorRT-LLM on both single GPU, single node multi-GPU and multi-node multi-GPU.

## Overview

The TensorRT-LLM Qwen-7B implementation can be found in [tensorrt_llm/models/qwen/model.py](../../tensorrt_llm/models/qwen/model.py). The TensorRT-LLM Qwen-7B example code is located in [`examples/qwen7b`](./). There are three main files in that folder::

 * [`build.py`](./build.py) to build the [TensorRT](https://developer.nvidia.com/tensorrt) engine(s) needed to run the Qwen-7B model,
 * [`run.py`](./run.py) to run the inference on an input text,
 * [`summarize.py`](./summarize.py) to summarize the articles in the [cnn_dailymail](https://huggingface.co/datasets/cnn_dailymail) dataset using the model.

## Usage

The TensorRT-LLM Qwen-7B example code locates at [examples/qwen](./). It takes HF weights as input, and builds the corresponding TensorRT engines. The number of TensorRT engines depends on the number of GPUs used to run inference.


### 1. Download weights from HuggingFace Transformers

```bash
# Weights & config
pip install -r requirements.txt
apt-get update
apt-get install git-lfs
rm -rf model && git clone https://huggingface.co/Qwen/Qwen-7B model
cp configuration_qwen.py model
```
### 2. Build TensorRT engine(s)

TensorRT-LLM Qwen-7B builds TensorRT engine(s) from HF checkpoint. If no checkpoint directory is specified, TensorRT-LLM will build engine(s) with dummy weights.

Normally `build.py` only requires single GPU, but if you've already got all the GPUs needed while inferencing, you could enable parallelly building to make the engine building process faster by adding `--parallel_build` argument. Please note that currently `parallel_build` feature only supports single node.

Here're some examples:

```bash
# Build a single-GPU float16 engine from HF weights.
# use_gpt_attention_plugin is necessary in Qwen.
# Try use_gemm_plugin to prevent accuracy issue.

# Build the Qwen 7B model using a single GPU and FP16.
python build.py --model_dir ./model \
                --dtype float16 \
                --use_gpt_attention_plugin float16 \
                --use_gemm_plugin float16 \
                --use_rmsnorm_plugin float16 \
                --output_dir ./trt_engines/qwen/7B/trt_engines/fp16/1-gpu/

# Build the Qwen 7B model using a single GPU and apply INT8 weight-only quantization.
python build.py --model_dir ./model \
                --dtype float16 \
                --use_gpt_attention_plugin float16 \
                --use_gemm_plugin float16 \
                --use_rmsnorm_plugin float16 \
                --use_weight_only \
                --output_dir ./trt_engines/qwen/7B/trt_engines/weight_only/1-gpu/
                
```

### 3. Run

To run a TensorRT-LLM Qwen model using the engines generated by build.py

```bash
# With fp16 inference
python3 run.py --max_output_len=8 \
               --tokenizer_dir ./model \
               --engine_dir=./trt_engines/qwen/7B/trt_engines/fp16/1-gpu/
               
# With weight_only inference
python3 run.py --max_output_len=8 \
               --tokenizer_dir ./model \
               --engine_dir=./trt_engines/qwen/7B/trt_engines/weight_only/1-gpu/
```

### 4. Summarization using the Qwen model

```bash
# Run summarization using the Qwen 7B HF model in FP16.
python summarize.py --test_hf \
                    --batch_size 1 \
                    --hf_model_location ./model \
                    --data_type fp16 \
                    --check_accuracy \
                    --tensorrt_llm_rouge1_threshold=14 \
                    --engine_dir ./trt_engines/qwen/7B/trt_engines/fp16/1-gpu/
                    
# Run summarization using the Qwen 7B TRT-LLM model in FP16.
python summarize.py --test_trt_llm \
                    --batch_size 1 \
                    --hf_model_location ./model \
                    --data_type fp16 \
                    --check_accuracy \
                    --tensorrt_llm_rouge1_threshold=14 \
                    --engine_dir ./trt_engines/qwen/7B/trt_engines/fp16/1-gpu/

# Run summarization using the Qwen 7B TRT-LLM model weight quantized to INT8.
python summarize.py --test_trt_llm \
                    --batch_size 1 \
                    --hf_model_location ./model \
                    --data_type fp16 \
                    --check_accuracy \
                    --tensorrt_llm_rouge1_threshold=14 \
                    --engine_dir ./trt_engines/qwen/7B/trt_engines/weight_only/1-gpu/
```

### 5. Benchmark using the Qwen model
```bash
# Run benchmark using the Qwen 7B TRT-LLM model in FP16.
python ./benchmarks/benchmark.py \
    -m qwen \
    --mode plugin \
    --batch_size "1" \
    --input_output_len "10,512" \
    --engine_dir ./trt_engines/qwen/7B/trt_engines/fp16/1-gpu/
    
# Run benchmark using the Qwen 7B TRT-LLM model quantized to INT8.
python ./benchmarks/benchmark.py \
    -m qwen \
    --mode plugin \
    --batch_size "1" \
    --input_output_len "10,512" \
    --use_weight_only \
    --engine_dir ./trt_engines/qwen/7B/trt_engines/weight_only/1-gpu/

```

### 6. INT8 KV Cache, export weights & scales for TensorRT-LLM

For int8 kv cache, [`hf_qwen_convert.py`](./hf_qwen_convert.py) features a
`--calibrate-kv-cache, -kv` option. Setting `-kv` will calibrate the model as
explained in [model transformation](#model-transformation) and export the
scaling factors needed for INT8 KV cache inference.

Example:

#### Calibrate KV cache
```bash
python3 hf_qwen_convert.py -i ./model -o ./trt_engines/qwen/7B/trt_engines/int8_kv_cache/ --calibrate-kv-cache -t float16
```

#### Build TensorRT engine(s)

[`build.py`](./build.py) add new options for the support of INT8 kv cache for models.
`--int8_kv_cache` forces KV cache to int8. We have to use int8 KV cache with GPT attention plugin
Examples of build invocations:

```bash
# Build the Qwen 7B model using a single GPU and apply INT8 kv cache.
python build.py --model_dir ./model \
                --dtype float16 \
                --use_gpt_attention_plugin float16 \
                --use_gemm_plugin float16 \
                --use_rmsnorm_plugin float16 \
                --int8_kv_cache \
                --output_dir ./trt_engines/qwen/7B/trt_engines/int8_kv_cache/1-gpu/
```
#### Run TensorRT engine(s)
```bash
# With int8_kv_cache inference
python3 run.py --max_output_len=10 \
               --tokenizer_dir ./model \
               --engine_dir=./trt_engines/qwen/7B/trt_engines/int8_kv_cache/1-gpu/
```

#### Summarization using the Qwen model

```bash
# Run summarization using the Qwen 7B model with int8 kv cache.
python summarize.py --test_trt_llm \
                    --hf_model_location ./model \
                    --data_type fp16 \
                    --engine_dir ./trt_engines/qwen/7B/trt_engines/int8_kv_cache/1-gpu/
```
#### Benchmark using the Qwen model
```bash
# Run benchmark using the Qwen 7B TRT-LLM model with int8 kv cache.
python ./benchmarks/benchmark.py \
    -m qwen \
    --mode plugin \
    --batch_size "1" \
    --input_output_len "10,512" \
    --int8_kv_cache \
    --engine_dir ./trt_engines/qwen/7B/trt_engines/int8_kv_cache/1-gpu/
```